({
  icons: {
    user: {
      fillStyle: "#34becd",
      svg: '<path d="M19.2 17.1v.7c0 .8-.6 1.4-1.4 1.4H6.2c-.8 0-1.4-.6-1.4-1.4v-.7c0-1.8 2-2.8 4-3.7 0 0 .1 0 .2-.1.1 0 .3 0 .4.1.8.5 1.7.8 2.6.8.9 0 1.8-.3 2.6-.8.1-.1.3-.1.4 0 .1 0 .2 0 .2.1 2 .8 4 1.8 4 3.6z" /><ellipse cx="12" cy="8.76" rx="3.576" ry="3.96" />',
    },
    opportunity: {
      fillStyle: "#fcb95b",
      svg: '<path d="M17.1 16.6H6.9c-.2 0-.4.2-.4.4 0 .8.6 1.5 1.4 1.5h8.2c.8 0 1.4-.7 1.4-1.5 0-.2-.2-.4-.4-.4zm1.1-9.9c-.8 0-1.4.7-1.4 1.5 0 .4.2.8.5 1.1-.4.9-1.3 1.5-2.4 1.5-1.3-.1-2.3-1.1-2.4-2.4v-.6c.6-.2.9-.7.9-1.3 0-.8-.6-1.5-1.4-1.5s-1.4.7-1.4 1.5c0 .6.3 1.1.9 1.3v.6c-.1 1.3-1.1 2.3-2.4 2.4-1.1.1-2-.6-2.4-1.5.3-.3.5-.7.5-1.1 0-.8-.6-1.5-1.4-1.5s-1.5.7-1.5 1.5.7 1.4 1.5 1.4l.6 5.1c.1.3.2.4.5.4h10.2c.2 0 .4-.1.5-.4l.6-5.1c.8 0 1.5-.6 1.5-1.4s-.7-1.5-1.5-1.5z" />',
    },
    account: {
      fillStyle: "#7f8de1",
      svg: '<path d="M19 12.3c0-.5-.4-.7-.5-.7h-5.3c-.4 0-.5.5-.5.5v5.7H19v-5.5zm-3.6 4c0 .3-.3.5-.5.5h-.5c-.3 0-.5-.2-.5-.5v-.5c0-.2.2-.5.5-.5h.5c.2 0 .5.3.5.5v.5zm0-2.5c0 .3-.3.5-.5.5h-.5c-.3 0-.5-.2-.5-.5v-.4c0-.3.2-.5.5-.5h.5c.2 0 .5.2.5.5v.4zm2.4 2.5c0 .3-.3.5-.5.5h-.5c-.3 0-.5-.2-.5-.5v-.5c0-.2.2-.5.5-.5h.5c.2 0 .5.3.5.5v.5zm0-2.5c0 .3-.3.5-.5.5h-.5c-.3 0-.5-.2-.5-.5v-.4c0-.3.2-.5.5-.5h.5c.2 0 .5.2.5.5v.4zm-3.6-4.1V6.9c0-.5-.4-.7-.5-.7H5.6c-.5 0-.6.5-.6.6v11h6.3v-7.1s0-.5.5-.5h1.9s.5-.3.5-.5zm-6.5 6.4c0 .2-.2.4-.5.4h-.5c-.2 0-.5-.2-.5-.4v-.5c0-.3.3-.5.5-.5h.5c.3 0 .5.2.5.5v.5zm0-2.5c0 .2-.2.5-.5.5h-.5c-.2 0-.5-.3-.5-.5v-.5c0-.3.3-.5.5-.5h.5c.3 0 .5.2.5.5v.5zm0-2.5c0 .3-.2.5-.5.5h-.5c-.2 0-.5-.2-.5-.5v-.4c0-.3.3-.5.5-.5h.5c.3 0 .5.2.5.5v.4zm0-2.4c0 .3-.2.5-.5.5h-.5c-.2 0-.5-.2-.5-.5v-.5c0-.3.3-.5.5-.5h.5c.3 0 .5.2.5.5v.5zm2.6 7.4c0 .2-.2.4-.5.4h-.4c-.3 0-.5-.2-.5-.4v-.5c0-.3.2-.5.5-.5h.4c.3 0 .5.2.5.5v.5zm0-2.5c0 .2-.2.5-.5.5h-.4c-.3 0-.5-.3-.5-.5v-.5c0-.3.2-.5.5-.5h.4c.3 0 .5.2.5.5v.5zm0-2.5c0 .3-.2.5-.5.5h-.4c-.3 0-.5-.2-.5-.5v-.4c0-.3.2-.5.5-.5h.4c.3 0 .5.2.5.5v.4zm0-2.4c0 .3-.2.5-.5.5h-.4c-.3 0-.5-.2-.5-.5v-.5c0-.3.2-.5.5-.5h.4c.3 0 .5.2.5.5v.5zm2.7 0c0 .3-.3.5-.5.5H12c-.3 0-.5-.2-.5-.5v-.5c0-.3.2-.5.5-.5h.5c.2 0 .5.2.5.5v.5z" />',
    },
    contact: {
      fillStyle: "#a094ed",
      svg: '<path d="M17.8 7H6.2c-.8 0-1.4.6-1.4 1.4v7c0 .8.6 1.4 1.4 1.4h11.6c.8 0 1.4-.6 1.4-1.4v-7c0-.8-.6-1.4-1.4-1.4zm-6.1 8.1H7.5c-.4 0-.8-.5-.8-1 0-.7.8-1.1 1.6-1.5.5-.2.6-.4.6-.7s-.1-.4-.3-.6c-.3-.3-.5-.7-.5-1.2 0-.9.5-1.7 1.5-1.7s1.5.8 1.5 1.7c0 .5-.2.9-.5 1.2-.2.2-.4.4-.4.6s.1.5.7.7c.8.3 1.5.8 1.5 1.5.1.5-.3 1-.7 1zm5.6-1.7c0 .3-.2.5-.5.5h-2.2c-.2 0-.4-.2-.4-.5v-.7c0-.2.2-.5.4-.5h2.2c.3 0 .5.3.5.5v.7zm0-2.6c0 .3-.2.5-.5.5h-3.6c-.3 0-.5-.2-.5-.5v-.7c0-.3.2-.5.5-.5h3.6c.3 0 .5.2.5.5v.7z" />',
    },
    contract: {
      fillStyle: "#6ec06e",
      svg: '<path d="M17.9 8.1l-3.2-3.2c0-.1-.1-.1-.2-.1-.2 0-.3.1-.3.3v2.6c0 .5.4.9.9.9h2.6c.2 0 .3-.1.3-.3 0-.1 0-.2-.1-.2zm-.4 2h-3.3c-.8 0-1.5-.7-1.5-1.5V5.3c0-.3-.2-.5-.5-.5H7.4c-.8 0-1.4.6-1.4 1.4v11.6c0 .8.6 1.4 1.4 1.4h9.2c.8 0 1.4-.6 1.4-1.4v-7.2c0-.3-.2-.5-.5-.5zM7.7 7.8l1.2-.1v-.1l.6-1.1h.1l.6 1.1v.1l1.2.1c.1 0 .1.1.1.2l-.9.8v.1l.2 1.2c0 .1-.1.1-.2.1l-1-.6h-.1l-1.1.6s-.1 0-.1-.1l.2-1.2-.1-.1-.8-.8c0-.1 0-.2.1-.2zm7.4 8c0 .3-.2.5-.5.5H8.4c-.3 0-.5-.2-.5-.5v-.4c0-.3.2-.5.5-.5h6.2c.3 0 .5.2.5.5v.4zm1-2.8c0 .2-.2.4-.5.4H8.4c-.3 0-.5-.2-.5-.4v-.5c0-.3.2-.5.5-.5h7.2c.3 0 .5.2.5.5v.5z" />'
    },
    endorsement: {
      fillStyle: "#8b9ae3",
      svg: '<path d="M6.7 10.1H5.3c-.3 0-.5.2-.5.5v7.7c0 .3.2.4.5.4h.5c.8 0 1.4-.6 1.4-1.4v-6.7c0-.3-.2-.5-.5-.5zm10.6.2h-1.5c-.8 0-1.4-.6-1.4-1.4V6c0-.8-.6-1.4-1.4-1.4h-1c-.3 0-.5.2-.5.4v2c0 1.6-.8 3.3-2.4 3.3-.2 0-.5.2-.5.5v6.7c0 .3.2.5.5.5 2.1.1 3.5.9 5.8.9 2.4 0 4.3-.7 4.3-3v-3.7c0-1-.9-1.9-1.9-1.9z" />',
    },
    lead: {
      fillStyle: "#f88962",
      svg: '<circle cx="12" cy="6.96" r="2.16" /><path d="M18.7 10.6H5.3c-.5 0-.7.6-.3.8l3.5 2.3c.2.1.3.3.2.5l-1.3 4.4c-.2.5.5.8.8.5l3.4-3.6c.2-.3.6-.3.8 0l3.4 3.6c.3.3.9 0 .8-.5l-1.3-4.4c-.1-.2 0-.4.2-.5l3.5-2.3c.4-.2.2-.8-.3-.8z" />'
    },
    home: {
      fillStyle: "#ef7ead",
      svg: '<path d="M18.9 12.3h-1.5v6.6c0 .2-.1.3-.3.3h-3c-.2 0-.3-.1-.3-.3v-5.1h-3.6v5.1c0 .2-.1.3-.3.3h-3c-.2 0-.3-.1-.3-.3v-6.6H5.1c-.1 0-.3-.1-.3-.2s0-.2.1-.3l6.9-7c.1-.1.3-.1.4 0l7 7v.3c0 .1-.2.2-.3.2z" />'
    },
    dashboard: {
      fillStyle: "#ef6e64",
      svg: '<path d="M12 4.8C8 4.8 4.8 8 4.8 12S8 19.2 12 19.2s7.2-3.2 7.2-7.2S16 4.8 12 4.8zm0 1.9c2.9 0 5.3 2.4 5.3 5.3 0 .2 0 .5-.1.7h-2.1c-.2 0-.4.2-.5.4-.2 1.3-1.3 2.3-2.6 2.3s-2.4-1-2.6-2.3c0-.2-.3-.4-.5-.4H6.8c-.1-.2-.1-.5-.1-.7 0-2.9 2.4-5.3 5.3-5.3zm-.6 7.1c.6.3 1.4 0 1.7-.5.4-.9 1.3-4.6 1.1-4.7-.2-.1-2.8 2.7-3.2 3.6-.4.5-.2 1.3.4 1.6z" />'
    },
    document: {
      fillStyle: "#baac93",
      svg: '<path d="M17.5 10.1h-3.3c-.8 0-1.5-.7-1.5-1.5V5.3c0-.3-.2-.5-.5-.5H7.4c-.8 0-1.4.6-1.4 1.4v11.6c0 .8.6 1.4 1.4 1.4h9.2c.8 0 1.4-.6 1.4-1.4v-7.2c0-.3-.2-.5-.5-.5zm.4-2l-3.2-3.2c0-.1-.1-.1-.2-.1-.2 0-.3.1-.3.3v2.6c0 .5.4.9.9.9h2.6c.2 0 .3-.1.3-.3 0-.1 0-.2-.1-.2z" />'
    }
  },
  // TODO: Refactor closure below to use gameState
  // gameState: {
  //   height:0,
  //   width: 0,
  //   isGameOver: false,
  //   sprites:[],
  //   maxScore:0,
  //   recordScore: 0,
  //   playing: true,
  //   environment: {},
  // },
  getIcon: function(icon) {
    if (!icon.singleton) {
      var img = new Image();
      img.src = 'data:image/svg+xml;xml,<svg xmlns="http://www.w3.org/2000/svg" version="1.1">' + icon.svg + '</svg>';
      icon.singleton = img;
    }
    return icon.singleton;
  },
  drawLoop: function(canvas, cmp) {
    var playing = cmp.get("v.playing");
    var width = canvas.width;
    var height = canvas.height;
    var recordScore = localStorage.getItem("recordScore");
    var isGameOver = false;
    var time = 0;
    var frame = 0;
    var helper = this;
    var maxScore = 0;
    var sprites = [];

    var canvas2d = canvas.getContext("2d");
    var environment = this.createEnvironment(width,height,0.01,this.PointAt(0,5));
    environment.context = canvas2d;
    canvas.addEventListener('mousemove', function(e) {
      environment.mousex = e.offsetX;
      environment.mousey = e.offsetY;
    });
    canvas.addEventListener('click', function(e) {
      helper.addBall(e.offsetX, e.offsetY, sprites, environment);
    });

    var half = (width / 2);
    var initialState = function() {
      helper.timer = undefined;
      // Create a pentagram for satan
      var d = 50; // Distance between points
      var v = Math.random() * 3; // Starting velocity
      var neg = Math.round(Math.random()) == 0;
      var offsetX = (neg ? -Math.random() : width + Math.random());
      neg = Math.round(Math.random()) == 0;
      var offsetY = Math.random() * height;

      var createSprite = function(x,y) {
        var ret = helper.towerSpriteAt(offsetX + x, offsetY - y, 1, environment);
        ret.prev.x = ret.x;
        ret.prev.y = ret.y;
        ret.scorable = false;
        sprites.push(ret);
        return ret;
      };
      // Five points with 72 degrees between them (units in rads)   
      var x = d * Math.cos(0);
      var y = d * Math.sin(0);
      var one = createSprite(x,y);
      x = d * Math.cos(1.25664);
      y = d * Math.sin(1.25664);
      var two = createSprite(x,y);
      x = d * Math.cos(2.51327);
      y = d * Math.sin(2.51327);
      var three = createSprite(x,y);
      x = d * Math.cos(3.76991);
      y = d * Math.sin(3.76991);
      var four = createSprite(x,y);
      x = d * Math.cos(5.02655);
      y = d * Math.sin(5.02655);
      var five = createSprite(x,y);
      var d = helper.getDistance(one,two);
      // Pentagon lines
      one.addConstraint(two, d);
      two.addConstraint(three, d);
      three.addConstraint(four, d);
      four.addConstraint(five, d);
      five.addConstraint(one, d);
      // Pentagram lines
      var d = helper.getDistance(one,three);
      one.addConstraint(three, d);
      one.addConstraint(four, d);
      two.addConstraint(five, d);
      two.addConstraint(four, d);
      three.addConstraint(five, d);
    };
    initialState();
    var drawFrame = function() {
      if (playing){
        requestAnimationFrame(drawFrame);
      }
      time = frame/60;
      if(time * 60 | 0 == frame - 1){
        time += 0.000001;
      }
      frame++;
      // Clear canvas and draw new frame
      environment.context.clearRect(0,0,environment.width,environment.height);
      for (var i=0; i<sprites.length; i++) {
        // Update sprite locations
        if (sprites[i].tick) sprites[i].tick(0.5);
      }
      for (var i=0; i<sprites.length; i++) {
        // Draw the supporting structure
        sprites[i].drawStructure(environment.context);
      }
      for (var i=0; i<sprites.length; i++) {
        // Draw the balls on top of structure
        sprites[i].draw(environment.context);
      }

      // Check if mouse is near points that could be connected
      var sprite = helper.PointAt(environment.mousex, environment.mousey);
      var endpoints = helper.findTriangle(sprite, sprites);
      var left, right;
      if (endpoints[0] && endpoints[1]) {
        left = endpoints[0];
        right = endpoints[1];
      }

      // Draw dashed line to candidate points
      var c = environment.context;
      if (left && right) {
        c.save();
        c.beginPath();
        c.setLineDash([5, 15]);
        c.strokeStyle = helper.rgb(0,0,0,0.5);
        c.moveTo(sprite.x, sprite.y);
        c.lineTo(left.x, left.y);
        c.moveTo(sprite.x, sprite.y);
        c.lineTo(right.x, right.y);
        c.stroke();
        c.restore();
      }

      // Get score (highest connected point)
      var highScore = height - sprites.reduce(function(prev, cur) {
        if (cur && cur.y && cur.constraints && cur.constraints.length > 0 && cur.scorable !== false) {
          return Math.min(prev, Math.round(cur.y));
        }
        else {
          return prev;
        }
      }, height);

      // Update score
      if (highScore < height) {
        var scoreDiff = maxScore - highScore;
        maxScore = Math.max(highScore, maxScore);
        // Check is score is beyond threshold of max game score (GAME OVER)
        if (scoreDiff > 100 || isGameOver) {
          isGameOver = true;
          c.save();
          var size = 24;
          c.font = size + "px Andale Mono";
          c.strokeStyle = "rgba(255,255,255,0.5)";
          var gameOver = "GAME OVER";
          var textSize = c.measureText(gameOver);
          c.translate(width/2, height/4);
          c.fillText(gameOver, -Math.round(textSize.width / 2),size/2);
          c.strokeText(gameOver, -Math.round(textSize.width / 2),size/2);
          textSize = c.measureText(helper.formatScore(highScore));
          c.translate(-((textSize.width+24)/2), size);
          helper.drawScore(c, maxScore, maxScore >= recordScore);
          c.restore();
          if (maxScore > recordScore) {
            // Record Score (Fireworks)
            recordScore = maxScore;
            localStorage.setItem("recordScore", maxScore);
            helper.createComponent("APXT_Redlining:Fireworks", {})
            .then(function(fireworks) {
              cmp.set("v.fireworks", fireworks);
            });
          }
          // Stop the game after short animation delay (to play us out)
          if (!helper.timer) {
            helper.timer = setTimeout(function() {
              clearInterval(helper.timer);
              helper.mixpanelIncrement("GamesPlayed");
              playing = false;
            }, 2000);
          }
        }

        if (highScore > 0) {
          c.save();
          c.translate(width-100,10);
          helper.drawScore(c, recordScore, true);
          c.translate(0,29);
          helper.drawScore(c, maxScore, maxScore > recordScore);
          c.restore();
        }
      }

    };
    drawFrame();
  },
  formatScore: function(score) {
    // This pads the score with extra 0s for arcadey style and visual alignment
    var str = "0000" + score;
    return str.substring(str.length - 4);
  },
  addBall: function(x,y, sprites, environment) {
    var pop = this.findTriangle(this.PointAt(x,y), sprites);
    if (pop && pop.length == 2) {
      var sprite = this.towerSpriteAt(x, y, 1.0, environment);
      // Push in random direction
      sprite.prev.x = sprite.x;
      sprite.prev.y = sprite.y;
      sprite.prev.x += (Math.random() * 20) - 10;
      sprite.prev.y += (Math.random()* 20) - 10;
      
      if (pop[0] && pop[1]) {
        var left = this.getDistance(sprite, pop[0]);
        var right = this.getDistance(sprite, pop[1]);
        sprite.addConstraint(pop[0], left);
        sprite.addConstraint(pop[1], right);
      }
      sprites.push(sprite);
    }
  },
  getDistance: function(pointX, pointY){
    return Math.sqrt(Math.pow(pointX.x - pointY.x, 2) + Math.pow(pointX.y - pointY.y,2));
  },
  findTriangle: function(sprite, sprites) {
    // Find two nearest sprites
    var NEAR = 200; // Can find when within this many pixels
    var ret = [];
    var helper = this;
    if (sprites && sprites.length > 1) {
      // Create sorted array by distance from point
      var distanceMap = sprites.map(function(p, i) {
        return {
          distance: helper.getDistance(sprite,p),
          sprite: p,
          index: i
        };
      });
      var sortedMap = distanceMap.sort(function(a, b){
        return +(a.distance > b.distance) || +(a.distance === b.distance) - 1;
      });
      if (sortedMap[0].distance < NEAR && sortedMap[1].distance < NEAR) {
        // Return two nearest points
        ret = [sortedMap[0].sprite, sortedMap[1].sprite];
      }
    }
    return ret;
  },
  drawScore: function(pen, score, isRecord) {
    var size = 24;
    var half = size/2;
    var iconSize = 16;
    var p = 10;
    pen.save();
    pen.font = size + "px Andale Mono";
    pen.textBaseline = 'bottom';
    // Draw icon background
    pen.strokeStyle = "rgba(255,255,255,0.5)";

    // Draw icon
    if (isRecord) {
      pen.fillStyle = this.icons.opportunity.fillStyle;
      pen.beginPath();
      pen.arc(half, half, half, 0, 2*Math.PI, false);
      pen.fill();
      pen.drawImage(this.getIcon(this.icons.opportunity),0,0);
    }
    else {
      pen.fillStyle = this.icons.user.fillStyle;
      pen.beginPath();
      pen.arc(half, half, half, 0, 2*Math.PI, false);
      pen.fill();
      pen.drawImage(this.getIcon(this.icons.user),0,0);
    }
    pen.fillStyle = "#000000";
    var score = this.formatScore(Math.round(score));
    pen.fillText(score, p+iconSize, p + iconSize);
    pen.strokeText(score, p+iconSize, p + iconSize);
    pen.restore();
  },
  towerSpriteAt:function(x, y, mass, environment, pointSize) {
    var helper = this;
    if (typeof pointSize !== "number") {
      pointSize = 20;
    }
    var half = pointSize/2;
    var ret = this.PointMassAt(x,y,mass,environment, pointSize);
    if (!this.iconArr) {
      this.iconArr = [];
      for (var name in helper.icons) {
        this.iconArr.push(helper.icons[name]);
      }
    }
    ret.icon = this.iconArr[Math.round(Math.random() * (this.iconArr.length - 1))];

    ret.drawStructure = function(pen) {
      if (ret.constraints) {
        pen.save();
        // Draw lines between connected points
        for (var i=0; i<ret.constraints.length; i++) {
          var point = ret.constraints[i].point;
          var px = Math.round(point.x);
          var py = Math.round(point.y);
          pen.beginPath();
          pen.strokeStyle = "rgba(0,0,0,1)";
          pen.lineWidth = Math.round(pointSize * 0.25);
          pen.moveTo(px, py);
          pen.lineTo(Math.round(ret.x), Math.round(ret.y));
          pen.stroke();
          pen.lineWidth = Math.round(pointSize * 0.1);
          pen.moveTo(px, py);
          pen.lineTo(Math.round(ret.x), Math.round(ret.y));
          pen.strokeStyle = "rgba(255,255,255,0.5)";
          pen.stroke();
        }
        pen.restore();
      }
    };
    ret.draw = function(pen) {
      var x = Math.round(ret.x); 
      var y = Math.round(ret.y);
      // Draw ball and icon
      var iconSize = 32;
      pen.save();
      pen.beginPath();
      pen.fillStyle = ret.icon.fillStyle;
      pen.arc(x, y, 16, 0, 2*Math.PI, false);
      pen.fill();
      pen.drawImage(helper.getIcon(ret.icon), 0, 0, 24, 24, x - iconSize/2, y - iconSize/2, iconSize, iconSize);
      pen.restore();
    };
    
    return ret;
  }
})